name: Reconcile Main

on:
  push:
    branches:
      - development

concurrency:
  group: reconcile-main
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  reconcile:
    name: Create PR for new commits
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: development
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch all branches
        run: |
          git fetch origin main
          git fetch origin development

      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          PR=$(gh pr list --base main --head development --json number --jq '.[0].number' || echo "")

          if [ -z "$PR" ]; then
            # Create new PR
            gh pr create \
              --base main \
              --head development \
              --title "Auto-merge: Reconcile development to main" \
              --body "Automatically created PR to reconcile passing commits from development to main." \
              --label auto-merge
          else
            # PR already exists, just update it (no-op, but ensures it's current)
            echo "PR #$PR already exists"
          fi
